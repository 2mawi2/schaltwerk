name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  tag-check:
    name: Validate Release Tag
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v6

      - name: Validate tag
        run: |
          set -euo pipefail
          tag_ver="${GITHUB_REF_NAME#v}"
          pkg_ver=$(jq -r '.version' package.json)
          if [[ -z "$pkg_ver" || "$pkg_ver" == "null" ]]; then
            echo "âŒ Failed to read version from package.json"
            exit 1
          fi
          if [[ "$tag_ver" != "$pkg_ver" ]]; then
            echo "âŒ Tag $tag_ver â‰  package.json $pkg_ver"
            exit 1
          fi
          echo "âœ… Tag matches package.json ($tag_ver)"

  test:
    name: Run Full Test Suite
    needs: tag-check
    runs-on: ubuntu-latest
    # Only run for tag pushes, not manual workflow dispatch
    if: startsWith(github.ref, 'refs/tags/')
    env:
      SCHALTWERK_PM: bun
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: sccache
      CARGO_INCREMENTAL: "0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Cache apt packages
        uses: actions/cache@v5
        id: apt-cache
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/release.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            mold \
            clang \
            sccache

      - name: Setup sccache cache
        uses: Mozilla-Actions/sccache-action@v0.0.9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.16'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Rust dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - uses: taiki-e/install-action@dfcb1ee29051d97c8d0f2d437199570008fd5612
        with:
          tool: cargo-shear
          version: 1.5.2

      - uses: taiki-e/install-action@dfcb1ee29051d97c8d0f2d437199570008fd5612
        with:
          tool: nextest
          version: 0.9.108
      - name: Install dependencies
        run: node scripts/package-manager.mjs install --frozen-lockfile

      - name: Install MCP server dependencies
        run: |
          if [ -d "mcp-server" ]; then
            cd mcp-server && node ../scripts/package-manager.mjs install --frozen-lockfile && cd ..
          fi

      - name: Run full test suite
        run: node scripts/package-manager.mjs run test

  test-windows:
    name: Run Windows Test Suite
    needs: tag-check
    runs-on: windows-latest
    if: false  # Temporarily disabled - Windows CI needs fixes
    env:
      SCHALTWERK_PM: bun
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: sccache
      CARGO_INCREMENTAL: "0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.16'

      - name: Setup sccache
        uses: Mozilla-Actions/sccache-action@v0.0.9

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache bun dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            mcp-server/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Restore cargo home cache
        id: cache_cargo_home_restore
        uses: actions/cache/restore@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: cargo-home-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Restore cargo target cache
        id: cache_target_restore
        uses: actions/cache/restore@v5
        with:
          path: src-tauri/target/
          key: cargo-target-${{ runner.os }}-${{ hashFiles('src-tauri/Cargo.lock') }}

      - uses: taiki-e/install-action@a983ca795126a4be4e8a44879ac5c4c3ef66cae1
        with:
          tool: cargo-shear
          version: 1.5.2

      - uses: taiki-e/install-action@a983ca795126a4be4e8a44879ac5c4c3ef66cae1
        with:
          tool: nextest
          version: 0.9.108

      - name: Install dependencies
        shell: bash
        run: |
          node scripts/package-manager.mjs install --frozen-lockfile
          if [ -d "mcp-server" ]; then
            cd mcp-server && node ../scripts/package-manager.mjs install --frozen-lockfile && cd ..
          fi

      - name: Run TypeScript lints
        shell: bash
        run: |
          node scripts/package-manager.mjs run lint
          node scripts/package-manager.mjs run lint:ts
          node scripts/package-manager.mjs run lint:mcp
          node scripts/package-manager.mjs run deps:check

      - name: Run frontend tests
        shell: bash
        run: |
          node scripts/package-manager.mjs run test:frontend
          node scripts/package-manager.mjs run test:mcp

      - name: Run Rust checks
        shell: bash
        working-directory: src-tauri
        run: |
          cargo clippy --all-features -- -D warnings
          cargo shear
          cargo test --no-run --lib --bins
          cargo build

      - name: Run Rust tests (pty_host)
        shell: bash
        working-directory: src-tauri/crates/pty_host
        run: cargo test

      - name: Save cargo home cache
        if: always() && !cancelled() && steps.cache_cargo_home_restore.outputs.cache-hit != 'true'
        continue-on-error: true
        uses: actions/cache/save@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: cargo-home-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Save cargo target cache
        if: always() && !cancelled() && steps.cache_target_restore.outputs.cache-hit != 'true'
        continue-on-error: true
        uses: actions/cache/save@v5
        with:
          path: src-tauri/target/
          key: cargo-target-${{ runner.os }}-${{ hashFiles('src-tauri/Cargo.lock') }}

  build-macos:
    name: Build macOS Universal Binary
    runs-on: macos-latest
    # Run in parallel with tests - both depend only on tag-check
    needs: [tag-check]
    if: always() && (needs.tag-check.result == 'success' || needs.tag-check.result == 'skipped')
    env:
      SCHALTWERK_PM: bun
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: sccache
      CARGO_INCREMENTAL: "0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.16'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Install sccache
        run: brew install sccache

      - name: Setup sccache cache
        uses: Mozilla-Actions/sccache-action@v0.0.9

      - name: Cache Rust dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-ci-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-ci-
            ${{ runner.os }}-cargo-

      - name: Install dependencies
        run: |
          node scripts/package-manager.mjs cache-clean || true
          rm -rf node_modules
          node scripts/package-manager.mjs install --frozen-lockfile

      # Tests run in separate workflow - releases depend on successful test runs
      # This saves ~3-4 minutes in release workflow

      - name: Build frontend
        run: node scripts/package-manager.mjs run build

      - name: Build MCP Server with Dependencies  
        run: |
          echo "ðŸ”¨ Building MCP server..."
          cd mcp-server
          node ../scripts/package-manager.mjs install --frozen-lockfile
          node ../scripts/package-manager.mjs run build
          # Install production dependencies for embedding
          node ../scripts/package-manager.mjs install --production --frozen-lockfile
          cd ..
          echo "âœ… MCP server built with dependencies"

      - name: Build for Intel and Apple Silicon with CI profile
        env:
          MACOSX_DEPLOYMENT_TARGET: '11.0'
          # Use CI profile for much faster builds
          CARGO_PROFILE_RELEASE_LTO: 'false'
          CARGO_PROFILE_RELEASE_CODEGEN_UNITS: '256'
          CARGO_PROFILE_RELEASE_OPT_LEVEL: '2'
          CARGO_TARGET_AARCH64_APPLE_DARWIN_RUSTFLAGS: '-C target-feature=+aes,+sha2,+crc,+neon'
        run: |
          # Build both targets in parallel with optimized settings (saves 2-3 minutes)
          # Use --bundles app to skip DMG bundling (we create a universal DMG manually later)
          node scripts/package-manager.mjs run tauri -- build --target x86_64-apple-darwin --bundles app &
          PID_INTEL=$!
          node scripts/package-manager.mjs run tauri -- build --target aarch64-apple-darwin --bundles app &
          PID_ARM=$!
          
          # Wait for both builds to complete
          wait $PID_INTEL
          INTEL_STATUS=$?
          wait $PID_ARM
          ARM_STATUS=$?
          
          # Check if both builds succeeded
          if [ $INTEL_STATUS -ne 0 ] || [ $ARM_STATUS -ne 0 ]; then
            echo "Build failed"
            exit 1
          fi

      - name: Create Universal Binary
        run: |
          # Create a universal binary app
          # Check multiple possible target directories
          TARGET_DIR="${CARGO_TARGET_DIR:-src-tauri/target}"
          
          # First check if files exist in the expected locations
          echo "ðŸ” Checking for app bundles..."
          
          ARM64_APP=""
          X64_APP=""
          
          # Check standard target directory first
          if [ -d "src-tauri/target/aarch64-apple-darwin/release/bundle/macos/schaltwerk.app" ]; then
            ARM64_APP="src-tauri/target/aarch64-apple-darwin/release/bundle/macos/schaltwerk.app"
            X64_APP="src-tauri/target/x86_64-apple-darwin/release/bundle/macos/schaltwerk.app"
            echo "âœ… Found apps in standard target directory"
          elif [ -d "/tmp/schaltwerk-shared-target/aarch64-apple-darwin/release/bundle/macos/schaltwerk.app" ]; then
            ARM64_APP="/tmp/schaltwerk-shared-target/aarch64-apple-darwin/release/bundle/macos/schaltwerk.app"
            X64_APP="/tmp/schaltwerk-shared-target/x86_64-apple-darwin/release/bundle/macos/schaltwerk.app"
            echo "âœ… Found apps in shared target directory"
          else
            echo "âŒ App bundles not found. Searching for them..."
            find . -name "schaltwerk.app" -type d 2>/dev/null || true
            find /tmp -name "schaltwerk.app" -type d 2>/dev/null || true
            exit 1
          fi
          
          echo "ðŸ“± ARM64 app: $ARM64_APP"
          echo "ðŸ“± x64 app: $X64_APP"
          
          # Copy the app bundles
          cp -R "$ARM64_APP" ./Schaltwerk-arm64.app
          cp -R "$X64_APP" ./Schaltwerk-x64.app
          
          # Create universal binary
          lipo -create \
            ./Schaltwerk-arm64.app/Contents/MacOS/schaltwerk \
            ./Schaltwerk-x64.app/Contents/MacOS/schaltwerk \
            -output ./schaltwerk-universal
          
          # Use the arm64 app as base and replace binary
          cp -R ./Schaltwerk-arm64.app ./Schaltwerk.app
          mv ./schaltwerk-universal ./Schaltwerk.app/Contents/MacOS/schaltwerk
          
          # Embed MCP server with dependencies in app bundle
          echo "ðŸ“¦ Embedding MCP server in app bundle..."
          mkdir -p ./Schaltwerk.app/Contents/Resources/mcp-server
          cp -R mcp-server/build ./Schaltwerk.app/Contents/Resources/mcp-server/
          cp mcp-server/package.json ./Schaltwerk.app/Contents/Resources/mcp-server/
          cp -R mcp-server/node_modules ./Schaltwerk.app/Contents/Resources/mcp-server/
          echo "âœ… MCP server embedded in app bundle with dependencies"
          
          # Ad-hoc sign the universal app
          codesign --force --deep -s - ./Schaltwerk.app
          
          # Clear extended attributes
          xattr -cr ./Schaltwerk.app

      - name: Create Updater Artifacts
        env:
          VERSION: ${{ github.event.inputs.version || github.ref_name }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.SCHALTWERK_UPDATER_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.SCHALTWERK_UPDATER_PRIVATE_KEY_PASSWORD }}
        run: |
          set -euo pipefail

          if [ -z "${TAURI_SIGNING_PRIVATE_KEY}" ]; then
            echo "Updater signing key is not configured"
            exit 1
          fi

          VERSION="${VERSION#v}"
          ARCHIVE_NAME="Schaltwerk-${VERSION}-macos-universal.app.tar.gz"
          RELEASE_TAG="v${VERSION}"
          RELEASE_URL="https://github.com/2mawi2/schaltwerk/releases/download/${RELEASE_TAG}/${ARCHIVE_NAME}"

          echo "Creating updater archive ${ARCHIVE_NAME}"
          tar -czf "$ARCHIVE_NAME" -C . Schaltwerk.app

          echo "Signing updater archive"
          printf '%s' "$TAURI_SIGNING_PRIVATE_KEY" > updater-private.key
          unset TAURI_SIGNING_PRIVATE_KEY
          SIGN_ARGS=(signer sign "$ARCHIVE_NAME" --private-key-path updater-private.key)
          if [ -n "${TAURI_SIGNING_PRIVATE_KEY_PASSWORD:-}" ]; then
            SIGN_ARGS+=(--password "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD")
          fi

          SIGNATURE=$(node scripts/package-manager.mjs run tauri -- "${SIGN_ARGS[@]}" | awk '/Public signature:/{getline; gsub(/\r/, ""); print}' | tr -d '\n')
          rm -f updater-private.key "$ARCHIVE_NAME.sig"

          if [ -z "$SIGNATURE" ]; then
            echo "Failed to extract updater signature"
            exit 1
          fi

          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > latest.json <<JSON
          {
            "version": "${VERSION}",
            "pub_date": "${PUB_DATE}",
            "notes": "",
            "platforms": {
              "darwin-aarch64-app": {
                "signature": "${SIGNATURE}",
                "url": "${RELEASE_URL}"
              },
              "darwin-x86_64-app": {
                "signature": "${SIGNATURE}",
                "url": "${RELEASE_URL}"
              },
              "darwin-aarch64": {
                "signature": "${SIGNATURE}",
                "url": "${RELEASE_URL}"
              },
              "darwin-x86_64": {
                "signature": "${SIGNATURE}",
                "url": "${RELEASE_URL}"
              }
            }
          }
          JSON

          echo "latest.json"
          cat latest.json

      - name: Create DMG
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"
          
          # Install create-dmg if not available
          brew install create-dmg || true
          
          # Create DMG with the universal app
          create-dmg \
            --volname "Schaltwerk ${VERSION}" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --skip-jenkins \
            --icon "Schaltwerk.app" 150 150 \
            --app-drop-link 450 150 \
            --hide-extension "Schaltwerk.app" \
            "Schaltwerk-${VERSION}-universal.dmg" \
            "Schaltwerk.app"

      - name: Calculate checksums
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"
          shasum -a 256 "Schaltwerk-${VERSION}-universal.dmg" > checksums.txt
          cat checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: macos-universal
          path: |
            Schaltwerk-*.dmg
            Schaltwerk-*.app.tar.gz
            checksums.txt
            latest.json

  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    needs: [tag-check]
    if: false  # Temporarily disabled - Windows builds not ready for release
    env:
      SCHALTWERK_PM: bun
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: sccache
      CARGO_INCREMENTAL: "0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.16'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        uses: Mozilla-Actions/sccache-action@v0.0.9

      - name: Cache Rust dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-ci-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-ci-
            ${{ runner.os }}-cargo-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build frontend
        run: bun run build

      - name: Build MCP Server
        shell: bash
        run: |
          cd mcp-server
          bun install --frozen-lockfile
          bun run build
          bun install --production --frozen-lockfile

      - name: Build Windows NSIS installer
        env:
          CARGO_PROFILE_RELEASE_LTO: 'false'
          CARGO_PROFILE_RELEASE_CODEGEN_UNITS: '256'
          CARGO_PROFILE_RELEASE_OPT_LEVEL: '2'
        run: bun run tauri build --bundles nsis

      - name: Prepare artifacts and sign for updater
        shell: pwsh
        env:
          VERSION: ${{ github.event.inputs.version || github.ref_name }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.SCHALTWERK_UPDATER_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.SCHALTWERK_UPDATER_PRIVATE_KEY_PASSWORD }}
        run: |
          $VERSION = $env:VERSION -replace '^v',''
          $NSIS_DIR = "src-tauri/target/release/bundle/nsis"

          $INSTALLER = Get-ChildItem "$NSIS_DIR/*.exe" | Select-Object -First 1
          if (-not $INSTALLER) {
            Write-Error "No NSIS installer found in $NSIS_DIR"
            exit 1
          }

          $EXE_NAME = "Schaltwerk-$VERSION-windows-x64.exe"
          Copy-Item $INSTALLER.FullName -Destination $EXE_NAME
          Write-Host "Created $EXE_NAME"

          $ZIP_NAME = "Schaltwerk-$VERSION-windows-x64.nsis.zip"
          Compress-Archive -Path $EXE_NAME -DestinationPath $ZIP_NAME
          Write-Host "Created $ZIP_NAME"

          if (-not $env:TAURI_SIGNING_PRIVATE_KEY) {
            Write-Error "Updater signing key is not configured"
            exit 1
          }

          $env:TAURI_SIGNING_PRIVATE_KEY | Out-File -FilePath "updater-private.key" -Encoding utf8 -NoNewline
          $env:TAURI_SIGNING_PRIVATE_KEY = $null

          $signArgs = @("signer", "sign", $ZIP_NAME, "--private-key-path", "updater-private.key")
          if ($env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD) {
            $signArgs += @("--password", $env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD)
          }

          $signOutput = & bun run tauri @signArgs 2>&1
          Write-Host $signOutput

          $SIGNATURE = ($signOutput | Select-String -Pattern "Public signature:" -Context 0,1).Context.PostContext[0].Trim()
          if (-not $SIGNATURE) {
            Write-Error "Failed to extract updater signature"
            exit 1
          }

          Remove-Item "updater-private.key" -ErrorAction SilentlyContinue
          Remove-Item "$ZIP_NAME.sig" -ErrorAction SilentlyContinue

          $SIGNATURE | Out-File -FilePath "windows-signature.txt" -Encoding utf8 -NoNewline
          Write-Host "Signature saved to windows-signature.txt"

          $HASH = (Get-FileHash $EXE_NAME -Algorithm SHA256).Hash.ToLower()
          "$HASH  $EXE_NAME" | Out-File -FilePath "windows-checksums.txt" -Encoding utf8

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v6
        with:
          name: windows-installer
          path: |
            Schaltwerk-*-windows-x64.exe
            Schaltwerk-*-windows-x64.nsis.zip
            windows-signature.txt
            windows-checksums.txt

  create-release:
    name: Create GitHub Release
    needs: [test, test-windows, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.test-windows.result == 'success' || needs.test-windows.result == 'skipped') &&
      (needs.build-macos.result == 'success') &&
      (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download macOS artifacts
        uses: actions/download-artifact@v7
        with:
          name: macos-universal
          path: artifacts/macos

      - name: Download Windows artifacts
        if: needs.build-windows.result == 'success'
        uses: actions/download-artifact@v7
        with:
          name: windows-installer
          path: artifacts/windows

      - name: Create latest.json (macOS only)
        env:
          VERSION: ${{ github.event.inputs.version || github.ref_name }}
        run: |
          set -euo pipefail
          # Use macOS latest.json directly (Windows disabled)
          cp artifacts/macos/latest.json artifacts/latest.json
          echo "latest.json (macOS only):"
          cat artifacts/latest.json

      - name: Prepare checksums
        run: |
          cat artifacts/macos/checksums.txt > artifacts/checksums.txt
          echo "Checksums:"
          cat artifacts/checksums.txt

      - name: Generate release notes
        id: release_notes
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          CURRENT_TAG="${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', github.event.inputs.version) }}"
          LAST_RELEASE=$(gh release list --exclude-drafts --limit 1 --json tagName -q '.[0].tagName' || echo "")

          if [ -z "$LAST_RELEASE" ] || [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "notes=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          COMMITS=$(git log "${LAST_RELEASE}..${CURRENT_TAG}" --oneline || echo "")

          if [ -z "$COMMITS" ]; then
            echo "notes=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PROMPT="You are a release notes writer for Schaltwerk, a Tauri desktop app for managing AI coding sessions with git worktrees. Analyze the following git commit log and generate release notes.

          Format (follow this exactly):
          ## What's New in ${CURRENT_TAG}

          ### Features
          - **Feature name** - Brief description

          ### Improvements
          - Description of user-visible enhancement

          ### Fixes
          - Fixed [specific issue description]

          ### Maintenance
          - Dependency updates (summarize Dependabot PRs as one line, e.g. 'Dependency updates via Dependabot')

          Style rules:
          - Omit sections that have no items entirely (do not include empty sections)
          - Features: use **bold name** followed by a dash and brief description
          - Fixes: always start each line with 'Fixed'
          - Improvements: describe what improved from the user's perspective
          - Keep descriptions concise, user-facing, and free of developer jargon
          - Group related commits (e.g. multiple style fixes) into a single line
          - Omit version bump commits (chore: bump version) and merge commits
          - Omit CI/workflow-only changes unless they affect users
          - Do not wrap the output in markdown code fences
          - Output only the release notes, no preamble or commentary

          Example of a good release note:
          ## What's New in v0.12.11

          ### Improvements
          - Improved contrast in diff viewer for better readability

          ### Fixes
          - Fixed log screen display when cloning repositories
          - Fixed settings save issue when on home screen

          ### Maintenance
          - Dependency updates

          Commit log:
          ${COMMITS}"

          PAYLOAD=$(jq -n \
            --arg prompt "$PROMPT" \
            '{
              model: "claude-haiku-4-5-20251001",
              max_tokens: 1024,
              messages: [{ role: "user", content: $prompt }]
            }')

          RESPONSE=$(curl -s --fail-with-body https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$PAYLOAD") || {
            echo "API call failed, falling back to empty notes"
            echo "notes=" >> "$GITHUB_OUTPUT"
            exit 0
          }

          NOTES=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [ -z "$NOTES" ]; then
            echo "notes=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          {
            echo "notes<<RELEASE_NOTES_EOF"
            echo "$NOTES"
            echo "RELEASE_NOTES_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', github.event.inputs.version) }}
          name: Schaltwerk ${{ github.event.inputs.version || github.ref_name }}
          draft: false
          prerelease: false
          body: ${{ steps.release_notes.outputs.notes }}
          generate_release_notes: ${{ steps.release_notes.outputs.notes == '' }}
          files: |
            artifacts/macos/*.dmg
            artifacts/macos/*.app.tar.gz
            artifacts/checksums.txt
            artifacts/latest.json
