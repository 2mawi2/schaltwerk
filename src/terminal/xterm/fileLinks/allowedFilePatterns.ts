import { minimatch } from 'minimatch'

// Derived from ripgrep's DEFAULT_TYPES list:
// https://github.com/BurntSushi/ripgrep/blob/master/crates/ignore/src/default_types.rs
const RIPGREP_FILE_GLOBS: readonly string[] = [
  '*.adb',
  '*.ads',
  '*.agda',
  '*.lagda',
  '*.aidl',
  'alire.toml',
  '*.mk',
  '*.bp',
  '*.adoc',
  '*.asc',
  '*.asciidoc',
  '*.asm',
  '*.s',
  '*.S',
  '*.aspx',
  '*.aspx.cs',
  '*.aspx.vb',
  '*.ascx',
  '*.ascx.cs',
  '*.ascx.vb',
  '*.asp',
  '*.ats',
  '*.dats',
  '*.sats',
  '*.hats',
  '*.avdl',
  '*.avpr',
  '*.avsc',
  '*.awk',
  '*.bat',
  '*.bazel',
  '*.bzl',
  '*.BUILD',
  '*.bazelrc',
  'BUILD',
  'MODULE.bazel',
  'WORKSPACE',
  'WORKSPACE.bazel',
  'WORKSPACE.bzlmod',
  '*.bb',
  '*.bbappend',
  '*.bbclass',
  '*.conf',
  '*.inc',
  '*.bx',
  '*.bxm',
  '*.bxs',
  '*.br',
  '*.bst',
  '*.bz2',
  '*.tbz2',
  '*.cabal',
  '*.did',
  '*.carp',
  '*.cbor',
  '*.ceylon',
  '*.cfc',
  '*.cfm',
  '*.clj',
  '*.cljc',
  '*.cljs',
  '*.cljx',
  '*.cmake',
  'CMakeLists.txt',
  '*.bat',
  '*.cmd',
  '*.cml',
  '*.coffee',
  '*.cfg',
  '*.conf',
  '*.config',
  '*.ini',
  '*.v',
  '*.creole',
  'Projectfile',
  '*.cr',
  '*.ecr',
  'shard.yml',
  '*.cs',
  '*.cs',
  '*.cshtml',
  '*.csproj',
  '*.css',
  '*.scss',
  '*.csv',
  '*.cu',
  '*.cuh',
  '*.pyx',
  '*.pxi',
  '*.pxd',
  '*.d',
  '*.dart',
  '*.dts',
  '*.dtsi',
  '*.dtso',
  '*.dhall',
  '*.patch',
  '*.diff',
  '*.dita',
  '*.ditamap',
  '*.ditaval',
  '*Dockerfile*',
  'docker-compose.yml',
  'docker-compose.*.yml',
  '*.dts',
  '*.dtsi',
  'Dvcfile',
  '*.dvc',
  '*.ebuild',
  '*.eclass',
  '*.edn',
  '*.el',
  '*.ex',
  '*.eex',
  '*.exs',
  '*.heex',
  '*.leex',
  '*.livemd',
  '*.elm',
  '*.erb',
  '*.erl',
  '*.hrl',
  '*.fnl',
  '*.fidl',
  '*.fish',
  '*.fbs',
  '*.f',
  '*.F',
  '*.f77',
  '*.F77',
  '*.pfo',
  '*.f90',
  '*.F90',
  '*.f95',
  '*.F95',
  '*.fs',
  '*.fsx',
  '*.fsi',
  '*.fut',
  '*.g',
  '*.gap',
  '*.gi',
  '*.gd',
  '*.tst',
  '*.gd',
  '*.gleam',
  '*.gn',
  '*.gni',
  '*.go',
  '*.gpr',
  '*.gradle',
  '*.gradle.kts',
  'gradle.properties',
  'gradle-wrapper.*',
  'gradlew',
  'gradlew.bat',
  '*.graphql',
  '*.graphqls',
  '*.groovy',
  '*.gradle',
  '*.gz',
  '*.tgz',
  '*.h',
  '*.hh',
  '*.hpp',
  '*.haml',
  '*.ha',
  '*.hs',
  '*.lhs',
  '*.cpphs',
  '*.c2hs',
  '*.hsc',
  '*.hbs',
  '*.hs',
  '*.lhs',
  '*.htm',
  '*.html',
  '*.ejs',
  '*.hy',
  '*.idr',
  '*.lidr',
  '*.janet',
  '*.java',
  '*.jsp',
  '*.jspx',
  '*.properties',
  '*.j2',
  '*.jinja',
  '*.jinja2',
  '*.jl',
  '*.js',
  '*.jsx',
  '*.vue',
  '*.cjs',
  '*.mjs',
  '*.json',
  'composer.lock',
  '*.sarif',
  '*.jsonl',
  '*.jl',
  '*.ipynb',
  '*.jpynb',
  '*.k',
  'Kconfig',
  'Kconfig.*',
  '*.kt',
  '*.kts',
  '*.lean',
  '*.less',
  'COPYING',
  '*.ly',
  '*.ily',
  '*.el',
  '*.jl',
  '*.lisp',
  '*.lsp',
  '*.sc',
  '*.scm',
  '*.ll',
  '*.lock',
  'package-lock.json',
  '*.log',
  '*.lua',
  '*.lz4',
  '*.lzma',
  '*.ac',
  '*.m4',
  '*.mako',
  '*.mao',
  '*.markdown',
  '*.md',
  '*.mdown',
  '*.mdwn',
  '*.mkd',
  '*.mkdn',
  '*.mdx',
  '*.m',
  'meson.build',
  'meson_options.txt',
  'meson.options',
  '*.min.html',
  '*.min.css',
  '*.min.js',
  '*.mint',
  'mkfile',
  '*.ml',
  '*.mo',
  '*.csproj',
  '*.fsproj',
  '*.vcxproj',
  '*.proj',
  '*.props',
  '*.targets',
  '*.sln',
  '*.slnf',
  '*.nim',
  '*.nimf',
  '*.nimble',
  '*.nims',
  '*.nix',
  '*.h',
  '*.m',
  '*.h',
  '*.mm',
  '*.ml',
  '*.mli',
  '*.mll',
  '*.mly',
  '*.org',
  '*.org_archive',
  'BUILD',
  '*.pas',
  '*.dpr',
  '*.lpr',
  '*.pp',
  '*.inc',
  '*.pdf',
  '*.perl',
  '*.pl',
  '*.PL',
  '*.plh',
  '*.plx',
  '*.pm',
  '*.t',
  '*.php',
  '*.php3',
  '*.php4',
  '*.php5',
  '*.php7',
  '*.php8',
  '*.pht',
  '*.phtml',
  '*.po',
  '*.pod',
  '*.eps',
  '*.ps',
  '*.pl',
  '*.pro',
  '*.prolog',
  '*.P',
  '*.proto',
  '*.cdxml',
  '*.ps1',
  '*.ps1xml',
  '*.psd1',
  '*.psm1',
  '*.epp',
  '*.erb',
  '*.pp',
  '*.rb',
  '*.purs',
  '*.py',
  '*.pyi',
  '*.pro',
  '*.pri',
  '*.prf',
  '*.qml',
  '*.qrc',
  '*.ui',
  '*.R',
  '*.r',
  '*.Rmd',
  '*.rmd',
  '*.Rnw',
  '*.rnw',
  '*.rkt',
  '*.raku',
  '*.rakumod',
  '*.rakudoc',
  '*.rakutest',
  '*.p6',
  '*.pl6',
  '*.pm6',
  '*.rdoc',
  'README*',
  '*README',
  '*.re',
  '*.rei',
  '*.r',
  '*.red',
  '*.reds',
  '*.res',
  '*.resi',
  '*.robot',
  '*.rst',
  'config.ru',
  'Gemfile',
  '.irbrc',
  'Rakefile',
  '*.gemspec',
  '*.rb',
  '*.rbw',
  '*.rake',
  '*.rs',
  '*.sass',
  '*.scss',
  '*.scala',
  '*.sbt',
  '*.scd',
  '*.scdoc',
  '*.sd7',
  '*.s7i',
  '.env',
  '.login',
  '.logout',
  '.profile',
  'profile',
  '.bash_login',
  'bash_login',
  '.bash_logout',
  'bash_logout',
  '.bash_profile',
  'bash_profile',
  '.bashrc',
  'bashrc',
  '*.bashrc',
  '.cshrc',
  '*.cshrc',
  '.kshrc',
  '*.kshrc',
  '.tcshrc',
  '.zshenv',
  'zshenv',
  '.zlogin',
  'zlogin',
  '.zlogout',
  'zlogout',
  '.zprofile',
  'zprofile',
  '.zshrc',
  'zshrc',
  '*.bash',
  '*.csh',
  '*.env',
  '*.ksh',
  '*.sh',
  '*.tcsh',
  '*.zsh',
  '*.skim',
  '*.slim',
  '*.slime',
  '*.tpl',
  '*.sml',
  '*.sig',
  '*.sol',
  '*.soy',
  '*.spark',
  '*.spec',
  '*.sql',
  '*.psql',
  '*.ssa',
  '*.styl',
  '*.v',
  '*.vg',
  '*.sv',
  '*.svh',
  '*.h',
  '*.svelte',
  '*.svelte.ts',
  '*.svg',
  '*.swift',
  '*.def',
  '*.i',
  '*.automount',
  '*.conf',
  '*.device',
  '*.link',
  '*.mount',
  '*.path',
  '*.scope',
  '*.service',
  '*.slice',
  '*.socket',
  '*.swap',
  '*.target',
  '*.timer',
  '*.taskpaper',
  '*.tcl',
  '*.tex',
  '*.ltx',
  '*.cls',
  '*.sty',
  '*.bib',
  '*.dtx',
  '*.ins',
  '*.texi',
  '*.textile',
  '*.tf',
  '*.tf.json',
  '*.tfvars',
  '*.tfvars.json',
  '*.terraformrc',
  'terraform.rc',
  '*.tfrc',
  '*.terraform.lock.hcl',
  '*.thrift',
  '*.toml',
  'Cargo.lock',
  '*.ts',
  '*.tsx',
  '*.cts',
  '*.mts',
  '*.twig',
  '*.txt',
  '*.typoscript',
  '*.ts',
  '*.typ',
  '*.usd',
  '*.usda',
  '*.usdc',
  '*.v',
  '*.vsh',
  '*.vala',
  '*.vb',
  '*.vcl',
  '*.v',
  '*.vh',
  '*.sv',
  '*.svh',
  '*.vhd',
  '*.vhdl',
  '*.vim',
  '.vimrc',
  '.gvimrc',
  'vimrc',
  'gvimrc',
  '_vimrc',
  '_gvimrc',
  '*.vim',
  '.vimrc',
  '.gvimrc',
  'vimrc',
  'gvimrc',
  '_vimrc',
  '_gvimrc',
  '*.vue',
  '*.idl',
  '*.webidl',
  '*.widl',
  '*.wgsl',
  '*.mediawiki',
  '*.wiki',
  '*.xml',
  '*.xml.dist',
  '*.dtd',
  '*.xsl',
  '*.xslt',
  '*.xsd',
  '*.xjb',
  '*.rng',
  '*.sch',
  '*.xhtml',
  '*.xz',
  '*.txz',
  '*.y',
  '*.yaml',
  '*.yml',
  '*.yang',
  '*.Z',
  '*.zig',
  '.zshenv',
  'zshenv',
  '.zlogin',
  'zlogin',
  '.zlogout',
  'zlogout',
  '.zprofile',
  'zprofile',
  '.zshrc',
  'zshrc',
  '*.zsh',
  '*.zst',
  '*.zstd'
]

const SIMPLE_EXTENSION_PATTERN = /^\*\.([A-Za-z0-9_-]+)$/
const WILDCARD_PATTERN = /(?:\*|\?|\[)/

const ALLOWED_EXTENSIONS = new Set<string>()
const ALLOWED_FILENAMES = new Set<string>()
const WILDCARD_GLOBS: string[] = []

for (const glob of RIPGREP_FILE_GLOBS) {
  const extMatch = glob.match(SIMPLE_EXTENSION_PATTERN)
  if (extMatch) {
    ALLOWED_EXTENSIONS.add(extMatch[1].toLowerCase())
    continue
  }
  if (!WILDCARD_PATTERN.test(glob)) {
    ALLOWED_FILENAMES.add(glob)
    continue
  }
  WILDCARD_GLOBS.push(glob)
}

export function isAllowedFileName(candidate: string): boolean {
  const normalized = candidate.trim()
  if (normalized.length === 0) return false

  const extIndex = normalized.lastIndexOf('.')
  if (extIndex > 0 && extIndex < normalized.length - 1) {
    const ext = normalized.slice(extIndex + 1).toLowerCase()
    if (ALLOWED_EXTENSIONS.has(ext)) {
      return true
    }
  }

  if (ALLOWED_FILENAMES.has(normalized)) {
    return true
  }

  return WILDCARD_GLOBS.some(pattern => minimatch(normalized, pattern))
}
